#ifndef iqtprm_CComposedParamsSetGuiComp_included
#define iqtprm_CComposedParamsSetGuiComp_included


// Qt includes
#include <QtCore/QString>
#include <QtCore/QSet>

// ACF includes
#include <ifile/IFilePersistence.h>
#include <iprm/IParamsSet.h>
#include <iqtgui/TDesignerGuiObserverCompBase.h>
#include <iqt2d/IViewExtender.h>
#include <iview/IShapeFactory.h>


#include <GeneratedFiles/iqtprm/ui_CComposedParamsSetGuiComp.h>


namespace iqtprm
{


class CComposedParamsSetGuiComp:
			public iqtgui::TDesignerGuiObserverCompBase<Ui::CComposedParamsSetGuiComp, iprm::IParamsSet>,
			virtual public iqt2d::IViewExtender,
			virtual public iview::IShapeFactory
{
	Q_OBJECT

public:
	typedef iqtgui::TDesignerGuiObserverCompBase<Ui::CComposedParamsSetGuiComp, iprm::IParamsSet> BaseClass;

	enum DesignType
	{
		DT_SIMPLE,
		DT_TOOL_BOX,
		DT_TAB_WIDGET
	};

	I_BEGIN_COMPONENT(CComposedParamsSetGuiComp);
		I_REGISTER_INTERFACE(iqt2d::IViewExtender);
		I_ASSIGN_MULTI_0(m_editorsCompPtr, "Editors", "List of GUI's for parameters edition", true);
		I_ASSIGN_TO(m_guisCompPtr, m_editorsCompPtr, true);
		I_ASSIGN_TO(m_observersCompPtr, m_editorsCompPtr, true);
		I_ASSIGN_TO(m_extendersCompPtr, m_editorsCompPtr, false);
		I_ASSIGN_TO(m_shapeFactoriesCompPtr, m_editorsCompPtr, false);
		I_ASSIGN(m_paramsLoaderCompPtr, "ParamsLoader", "Loader for the parameter set", false, "ParamsLoader");
		I_ASSIGN_MULTI_0(m_idsAttrPtr, "Ids", "List of parameter ID's according to defined editors, if ID equals '*' then the observed parameter set will be used, if it is empty than only GUI will be shown, but no parameter will be connected", true);
		I_ASSIGN_MULTI_0(m_namesAttrPtr, "Names", "List of of gui names", false);
		I_ASSIGN(m_useHorizontalLayoutAttrPtr, "UseHorizontalLayout", "Use horizontal layout", true, false);
		I_ASSIGN(m_useVerticalSpacerAttrPtr, "UseVerticalSpacer", "Use vertical spacer to keep inserted objects in place", true, false);
		I_ASSIGN(m_showAllShapesAttrPtr, "ShowAllShapes", "If true all shapes, also generated by inactive GUI, will be shown", true, false);
		I_ASSIGN(m_designTypeAttrPtr, "DesignType", "Type of design:\n* 0 - simple\n* 1 - tool box\n* 2 - tab", true, DT_SIMPLE);
		I_ASSIGN(m_tabOrientationAttrPtr, "TabBarOrientation", "Orientation of the tab bar for tab design\n 0 - North\n 1 - South\n 2 - West\n 3 - East", true, 0);
	I_END_COMPONENT;

	CComposedParamsSetGuiComp();

	// reimplemented (imod::IModelEditor)
	virtual void UpdateEditor(const istd::IChangeable::ChangeSet& changeSet);

	// reimplemented (iqtgui::CGuiComponentBase)
	virtual void OnGuiCreated();
	virtual void OnGuiDestroyed();

	// reimplemented (iqt2d::IViewExtender)
	virtual void AddItemsToScene(iqt2d::IViewProvider* providerPtr, int flags);
	virtual void RemoveItemsFromScene(iqt2d::IViewProvider* providerPtr);

	// reimplemented (iview::IShapeFactory)
	virtual iview::IShape* CreateShape(const istd::IChangeable* objectPtr, bool connectToModel = false) const;

protected:
	void AttachToScene(iqt2d::IViewProvider* providerPtr, int flags);
	void DetachFromScene(iqt2d::IViewProvider* providerPtr);

	// reimplemented (iqtgui::TGuiObserverWrap)
	virtual void OnGuiModelAttached();
	virtual void OnGuiModelDetached();
	virtual void UpdateModel() const;

	QList<imod::IModelEditor*> GetModelEditors() const;
	QList<QByteArray> GetIds() const;

protected Q_SLOTS:
	void OnEditorChanged(int index);
	void on_LoadParamsButton_clicked();
	void on_SaveParamsButton_clicked();

private:
	I_MULTIREF(imod::IModelEditor, m_editorsCompPtr);
	I_MULTIREF(iqtgui::IGuiObject, m_guisCompPtr);
	I_MULTIREF(imod::IObserver, m_observersCompPtr);
	I_MULTIREF(iqt2d::IViewExtender, m_extendersCompPtr);
	I_MULTIREF(iview::IShapeFactory, m_shapeFactoriesCompPtr);
	I_REF(ifile::IFilePersistence, m_paramsLoaderCompPtr);
	I_MULTIATTR(QByteArray, m_idsAttrPtr);
	I_MULTITEXTATTR(m_namesAttrPtr);
	I_ATTR(bool, m_useHorizontalLayoutAttrPtr);
	I_ATTR(bool, m_useVerticalSpacerAttrPtr);
	I_ATTR(bool, m_showAllShapesAttrPtr);
	I_ATTR(int, m_designTypeAttrPtr);
	I_ATTR(int, m_tabOrientationAttrPtr);
	I_ATTR(bool, m_flatViewAttrPtr);

	typedef QMap<imod::IModelEditor*, bool> ConnectedEditorsMap;
	ConnectedEditorsMap m_connectedEditorsMap;

	int m_currentGuiIndex;

	typedef QMap<iqt2d::IViewProvider*, int> ConnectedSceneFlags; // maps connected scene provider to connection flags
	ConnectedSceneFlags m_connectedSceneFlags;

	/**
		A container that depends on \c DesignType, i.e. QWidget, QToolBox or QTabWidget
	*/
	QWidget* m_guiContainerPtr;
	struct PanelData
	{
		PanelData()
		{
			pagePtr = NULL;
			paramWidgetPtr = NULL;
		}
		QWidget* pagePtr;
		QWidget* paramWidgetPtr;
	};
	QMap<iqtgui::IGuiObject*, PanelData> m_guiToWidgetMap;
};


} // namespace iqtprm


#endif // !iqtprm_CComposedParamsSetGuiComp_included


